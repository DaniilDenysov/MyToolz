name: Build MyToolz Assets Packages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  PROJECT_PATH: Assets
  OUTPUT_ROOT: build_output

jobs:
  discover:
    runs-on: ubuntu-22.04
    outputs:
      packages: ${{ steps.discover.outputs.packages }}
    steps:
      - uses: actions/checkout@v4

      - id: discover
        shell: bash
        run: |
          set -euo pipefail

          mapfile -t files < <(find "$PROJECT_PATH/Packages" -mindepth 2 -maxdepth 2 -name package.json -print | sort)

          if [ ${#files[@]} -eq 0 ]; then
            echo "::error ::No packages found."
            exit 1
          fi

          pkgs=()
          for f in "${files[@]}"; do
            pkgs+=("$(basename "$(dirname "$f")")")
          done

          json="$(printf '%s\n' "${pkgs[@]}" | jq -R . | jq -s .)"
          {
            echo "packages<<EOF"
            echo "$json"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"


  build:
    needs: discover
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        package: ${{ fromJson(needs.discover.outputs.packages) }}
      fail-fast: false

    steps:
      - uses: actions/checkout@v4

      - name: Prepare folder structure
        shell: bash
        run: |
          set -euo pipefail

          PKG="${{ matrix.package }}"
          SRC="$PROJECT_PATH/Packages/$PKG"

          VERSION=$(jq -r .version "$SRC/package.json")

          DEST="$OUTPUT_ROOT/MyToolz/$PKG"
          mkdir -p "$DEST"

          # Copy everything except Samples (optional handling)
          rsync -av --exclude="Samples" "$SRC/" "$DEST/"

          if [ -d "$SRC/Samples" ]; then
            mkdir -p "$DEST/Samples"
            rsync -av "$SRC/Samples/" "$DEST/Samples/"
          fi

          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "PACKAGE_NAME=$PKG" >> $GITHUB_ENV

      - name: Create UPM tgz
        shell: bash
        run: |
          set -euo pipefail
          PKG="${{ matrix.package }}"
          SRC="$PROJECT_PATH/Packages/$PKG"
      
          VERSION="$(jq -r .version "$SRC/package.json")"
          TGZ_NAME="${PKG}-${VERSION}.tgz"
      
          # Create clean staging dir
          STAGE="$(mktemp -d)"
          rsync -av \
            --exclude=".git" \
            --exclude="Tests" \
            --exclude="Test" \
            "$SRC/" "$STAGE/"
      
          # Unity convention: Samples should be Samples~ in distributed UPM packages
          if [ -d "$SRC/Samples" ]; then
            rm -rf "$STAGE/Samples"
            mkdir -p "$STAGE/Samples~"
            rsync -av "$SRC/Samples/" "$STAGE/Samples~/"
          fi
      
          tar -czf "$TGZ_NAME" -C "$STAGE" .
          mv "$TGZ_NAME" "$GITHUB_WORKSPACE/"


      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: upm-${{ matrix.package }}
          path: "*.tgz"

