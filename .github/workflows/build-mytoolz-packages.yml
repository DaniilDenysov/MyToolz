name: Build MyToolz Assets Packages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  PROJECT_PATH: Assets
  OUTPUT_ROOT: build_output

jobs:
  discover:
    runs-on: ubuntu-22.04
    outputs:
      packages: ${{ steps.discover.outputs.packages }}
    steps:
      - uses: actions/checkout@v4

      - id: discover
        shell: bash
        run: |
          set -euo pipefail

          mapfile -t files < <(find "$PROJECT_PATH/Packages" -mindepth 2 -maxdepth 2 -name package.json -print | sort)

          if [ ${#files[@]} -eq 0 ]; then
            echo "::error ::No packages found."
            exit 1
          fi

          pkgs=()
          for f in "${files[@]}"; do
            pkgs+=("$(basename "$(dirname "$f")")")
          done

          json="$(printf '%s\n' "${pkgs[@]}" | jq -R . | jq -s .)"
          {
            echo "packages<<EOF"
            echo "$json"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"


  build:
    needs: discover
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        package: ${{ fromJson(needs.discover.outputs.packages) }}
      fail-fast: false

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Prepare folder structure
        shell: bash
        run: |
          set -euo pipefail

          PKG="${{ matrix.package }}"
          SRC="$PROJECT_PATH/Packages/$PKG"

          VERSION=$(jq -r .version "$SRC/package.json")

          DEST="$OUTPUT_ROOT/MyToolz/$PKG"
          mkdir -p "$DEST"

          # Copy everything except Samples (optional handling)
          rsync -av --exclude="Samples" "$SRC/" "$DEST/"

          if [ -d "$SRC/Samples" ]; then
            mkdir -p "$DEST/Samples"
            rsync -av "$SRC/Samples/" "$DEST/Samples/"
          fi

          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "PACKAGE_NAME=$PKG" >> $GITHUB_ENV

      - name: Create UPM tgz (npm pack)
        shell: bash
        run: |
          set -euo pipefail
          PKG="${{ matrix.package }}"
          PKG_DIR="$PROJECT_PATH/Packages/$PKG"

          VERSION="$(jq -r .version "$PKG_DIR/package.json")"
          NAME_IN_JSON="$(jq -r .name "$PKG_DIR/package.json")"

          STAGE="$(mktemp -d)"
          rsync -av --exclude=".git" --exclude="Tests" "$PKG_DIR/" "$STAGE/"

          # Samples -> Samples~ (Unity expects Samples~ inside UPM packages)
          if [ -d "$PKG_DIR/Samples" ]; then
            rm -rf "$STAGE/Samples"
            mkdir -p "$STAGE/Samples~"
            rsync -av "$PKG_DIR/Samples/" "$STAGE/Samples~/"
          fi

          test -f "$STAGE/package.json"

          # npm pack creates a Unity/UPM-compatible .tgz
          npm --version >/dev/null 2>&1 || (echo "::error ::npm is required"; exit 1)

          pushd "$STAGE" >/dev/null
          OUT_TGZ="$(npm pack --silent)"
          popd >/dev/null

          # Normalize file name (optional)
          FINAL_TGZ="$GITHUB_WORKSPACE/${PKG}-${VERSION}.tgz"
          mv "$STAGE/$OUT_TGZ" "$FINAL_TGZ"

          # Sanity check: ensure package.json is present in the archive
          tar -tzf "$FINAL_TGZ" | grep -E '(^|/)package\.json$' >/dev/null \
            || (echo "::error ::package.json not found inside tgz"; exit 1)



      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: upm-${{ matrix.package }}
          path: "*.tgz"


      - name: Configure npm for GitHub Packages
        run: |
            echo "@DaniilDenysov:registry=https://npm.pkg.github.com" >> ~/.npmrc
            echo "//npm.pkg.github.com/:_authToken=${GITHUB_TOKEN}" >> ~/.npmrc
        env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
