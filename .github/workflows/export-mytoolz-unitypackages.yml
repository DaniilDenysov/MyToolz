name: Export MyToolz UnityPackages (multi)

on:
  push:
    branches: [ main ]
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

env:
  UNITY_VERSION: 2022.3.46f1
  OUT_DIR: build_output

jobs:
  export:
    name: Export unitypackages
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Mark workspace as safe (git)
        shell: bash
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: Validate UNITY_LICENSE secret
        shell: bash
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
        run: |
          set -euo pipefail
          if [ -z "${UNITY_LICENSE:-}" ]; then
            echo "::error ::UNITY_LICENSE secret is missing or empty. Paste the full .ulf file contents into UNITY_LICENSE."
            exit 1
          fi
          echo "UNITY_LICENSE present (len=${#UNITY_LICENSE})"

      - name: Prepare output dir
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "${OUT_DIR}"

      - name: Export all packages under Assets/Packages
        uses: game-ci/unity-builder@v4
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        with:
          unityVersion: ${{ env.UNITY_VERSION }}
          projectPath: .
          targetPlatform: StandaloneLinux64
          allowDirtyBuild: true
          buildMethod: MyToolz.CI.CIEntryPoint.ExportAllToolsUnderAssetsPackages
          customParameters: >-
            -batchmode
            -nographics
            -quit
            -logFile ${{ github.workspace }}/UnityEditor-ci.log
            -stackTraceLogType Full
            -logTimestamp
            -mytoolzOutDir ${{ github.workspace }}/${{ env.OUT_DIR }}
            -mytoolzMergeDeps true
            -mytoolzIncludeProjectDeps true

      - name: Dump logs to console (on failure)
        if: failure()
        shell: bash
        run: |
          echo "===== Tail: UnityEditor-ci.log ====="
          if [ -f "UnityEditor-ci.log" ]; then tail -n 250 "UnityEditor-ci.log"; else echo "UnityEditor-ci.log missing"; fi
          echo "===== Tail: Exporter-ci.log ====="
          if [ -f "${OUT_DIR}/Exporter-ci.log" ]; then tail -n 250 "${OUT_DIR}/Exporter-ci.log"; else echo "Exporter-ci.log missing"; fi
          echo "===== OUT_DIR content ====="
          ls -la "${OUT_DIR}" || true
          find "${OUT_DIR}" -maxdepth 2 -type f -print || true

      - name: Upload unitypackage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mytoolz-unitypackages
          path: ${{ env.OUT_DIR }}/*.unitypackage
          if-no-files-found: error
          retention-days: 14

      - name: Upload logs (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unity-logs
          path: |
            UnityEditor-ci.log
            ${{ env.OUT_DIR }}/Exporter-ci.log
            /home/runner/.config/unity3d/Editor.log
            /home/runner/.config/unity3d/Logs/**/*
            /github/home/.config/unity3d/Editor.log
            /github/home/.config/unity3d/Logs/**/*
          if-no-files-found: warn
          retention-days: 14
